<!DOCTYPE html>
<html>

<head>
    <title>Importar Acreditados SIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h2>Importar Acreditados SIS</h2>
        <form id="importForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="server" class="form-label">Server IP</label>
                <input type="text" class="form-control" id="server" name="server" value="db" required>
            </div>
            <div class="mb-3">
                <label for="port" class="form-label">Port</label>
                <input type="text" class="form-control" id="port" name="port" value="1433">
            </div>
            <div class="mb-3">
                <label for="user" class="form-label">User</label>
                <input type="text" class="form-control" id="user" name="user" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <div class="mb-3">
                <label for="file" class="form-label">ZIP File</label>
                <input type="file" class="form-control" id="file" name="file" accept=".zip" required>
            </div>
            <div class="mb-3">
                <label for="zip_password" class="form-label">ZIP Password (Optional)</label>
                <input type="password" class="form-control" id="zip_password" name="zip_password">
            </div>
            <div class="mb-3">
                <label for="strategy" class="form-label">Estrategia de Importación</label>
                <select class="form-select" id="strategy" name="strategy">
                    <option value="bulk" selected>Bulk Import (Rápido - Recomendado)</option>
                    <option value="iterative">Iterativo (Lento - Legado)</option>
                </select>
                <div class="form-text">
                    <strong>Bulk:</strong> Usa tablas temporales y operaciones masivas.
                    <strong>Iterativo:</strong> Procesa fila por fila verificando existencia.
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Import</button>
        </form>
        <div class="mt-3">
            <div class="progress" style="display:none;" id="progressBarContainer">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                    style="width: 0%;" id="progressBar">Waiting...</div>
            </div>
            <div class="card mt-3">
                <div class="card-header">
                    Proceso
                </div>
                <div class="card-body bg-light" style="max-height: 200px; overflow-y: auto;" id="processLog">
                    <small class="text-muted">Esperando inicio...</small>
                </div>
            </div>
            <div id="statusMessage" class="mt-2 fw-bold"></div>
        </div>
    </div>

    <script>
        // Restore values from localStorage
        window.addEventListener('load', () => {
            const ids = ['server', 'port', 'user', 'password', 'zip_password'];
            ids.forEach(id => {
                const val = localStorage.getItem(id);
                if (val) document.getElementById(id).value = val;
            });
        });

        // Save values to localStorage on input
        const inputs = ['server', 'port', 'user', 'password', 'zip_password'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                localStorage.setItem(id, e.target.value);
            });
        });

        document.getElementById('importForm').onsubmit = async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressBarContainer');
            const statusMessage = document.getElementById('statusMessage');
            const processLog = document.getElementById('processLog');

            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.innerText = 'Iniciando...';
            statusMessage.innerText = '';
            statusMessage.className = '';
            processLog.innerHTML = ''; // Clear log

            try {
                const response = await fetch('/import', {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6).trim();

                            if (message.startsWith('Progress:')) {
                                // Format: Progress: 5000 records processed (10%)
                                const parts = message.match(/\((\d+)%\)/);
                                if (parts && parts[1]) {
                                    const percent = parts[1];
                                    progressBar.style.width = percent + '%';
                                    progressBar.innerText = percent + '%';
                                }
                                // Update log for major steps, but dont flood
                                statusMessage.innerText = message;
                            }
                            else if (message.startsWith('Success:')) {
                                progressBar.style.width = '100%';
                                progressBar.classList.remove('progress-bar-animated');
                                progressBar.className = 'progress-bar bg-success';
                                progressBar.innerText = 'Completado';

                                statusMessage.className = 'text-success';
                                statusMessage.innerText = message;

                                const p = document.createElement('div');
                                p.className = 'text-success';
                                p.innerText = message;
                                processLog.prepend(p);
                            }
                            else if (message.startsWith('Error:')) {
                                progressBar.className = 'progress-bar bg-danger';
                                statusMessage.className = 'text-danger';
                                statusMessage.innerText = message;

                                const p = document.createElement('div');
                                p.className = 'text-danger fw-bold';
                                p.innerText = message;
                                processLog.prepend(p);
                            }
                            else if (message.startsWith('Log:')) {
                                const params = message.substring(4);
                                const p = document.createElement('div');
                                p.innerText = `> ${params}`;
                                processLog.prepend(p);
                            }
                        }
                    });
                }

            } catch (error) {
                statusMessage.className = 'text-danger';
                statusMessage.innerText = 'Network Error: ' + error.message;
            }
        };
    </script>
</body>

</html>